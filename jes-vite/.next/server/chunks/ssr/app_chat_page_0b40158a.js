module.exports=[51107,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(13674),e=a.i(15336),f=a.i(46271),g=a.i(50944),h=a.i(19332),i=a.i(21673),j=a.i(98070),k=a.i(11886);async function l(a,b="jes-store-salt-v1"){let c=new TextEncoder,d=await crypto.subtle.importKey("raw",c.encode(a),"PBKDF2",!1,["deriveBits","deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:c.encode(b),iterations:1e5,hash:"SHA-256"},d,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}async function m(a,b){let c=new TextEncoder,d=crypto.getRandomValues(new Uint8Array(12)),e=await crypto.subtle.encrypt({name:"AES-GCM",iv:d},b,c.encode(a)),f=new Uint8Array(d.length+e.byteLength);return f.set(d),f.set(new Uint8Array(e),d.length),btoa(String.fromCharCode(...f))}async function n(a,b){let c=Uint8Array.from(atob(a),a=>a.charCodeAt(0)),d=c.slice(0,12),e=c.slice(12),f=await crypto.subtle.decrypt({name:"AES-GCM",iv:d},b,e);return new TextDecoder().decode(f)}async function o(a,b){return await m(a,b)}async function p(a,b){try{return await n(a,b)}catch(a){return console.error("Decryption failed:",a),"[Mensaje cifrado - No se pudo descifrar]"}}async function q(a,b){let c=[a,b].sort().join(":");return await l(c,"jes-conversation-key-v1")}function r(){let{session:a,friends:l,isLoggedIn:m,loading:n}=(0,i.useWishlist)(),r=(0,g.useSearchParams)().get("user"),[s,t]=(0,c.useState)("list"),[u,v]=(0,c.useState)(null),[w,x]=(0,c.useState)({}),[y,z]=(0,c.useState)(""),[A,B]=(0,c.useState)([]),C=(0,c.useRef)(null),[D,E]=(0,c.useState)({}),[F,G]=(0,c.useState)(!0),[H,I]=(0,c.useState)(!1),[J,K]=(0,c.useState)(!1),L={id:"jarvis-ai",name:"JARVIS",avatar:"ðŸ¤–",lastMsg:"Tu asistente personal de JES",type:"ai",online:!0},M=l.map(a=>({id:a.id,name:a.name||a.email?.split("@")[0]||"Amigo",avatar:a.avatar_url,lastMsg:"...",type:"friend",online:A.includes(a.id)})),N=[L,...M],[O,P]=(0,c.useState)(N);(0,c.useEffect)(()=>{P([L,...M])},[l,A]),(0,c.useEffect)(()=>{if(!a?.user?.id)return;let b=h.supabase.channel("online-users",{config:{presence:{key:a.user.id}}});return b.on("presence",{event:"sync"},()=>{B(Object.keys(b.presenceState()))}).on("presence",{event:"join"},({key:a})=>{B(b=>[...b,a])}).on("presence",{event:"leave"},({key:a})=>{B(b=>b.filter(b=>b!==a))}).subscribe(async c=>{"SUBSCRIBED"===c&&await b.track({user_id:a.user.id,online_at:new Date().toISOString()})}),()=>{h.supabase.removeChannel(b)}},[a?.user?.id]),(0,c.useEffect)(()=>{!async function(){if(!r||n)return;let a=N.find(a=>a.id===r);if(a){v(a),t("chat");return}let{data:b}=await h.supabase.from("profiles").select("*").eq("id",r).single();if(b){let a={id:b.id,name:b.name,avatar:b.avatar_url||"ðŸ‘¤",lastMsg:"Â¡Parchamos!",type:"friend",online:!0};P(b=>[a,...b]),v(a),t("chat")}}()},[r,n]),(0,c.useEffect)(()=>{if(!u||!a?.user?.id)return;!async function(){I(!0);try{let b=D[u.id];b||(b=await q(a.user.id,u.id),E(a=>({...a,[u.id]:b})));let{data:c,error:d}=await h.supabase.from("messages").select("*").or(`and(sender_id.eq.${a.user.id},receiver_id.eq.${u.id}),and(sender_id.eq.${u.id},receiver_id.eq.${a.user.id})`).order("created_at",{ascending:!0});if(d)throw d;if(c){let d=await Promise.all(c.map(async c=>{let d=c.content;if(c.is_encrypted&&b)try{d=await p(c.content,b)}catch(a){d="[Error al descifrar]"}return{id:c.id,sender:c.sender_id===a.user.id?"Yo":u.name,text:d,time:new Date(c.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),isEncrypted:c.is_encrypted}}));x(a=>({...a,[u.id]:d}))}}catch(a){console.error("Error in chat initialization:",a)}finally{I(!1)}}();let b=h.supabase.channel(`chat_${u.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},async b=>{let c=b.new;if(c.sender_id===a.user.id&&c.receiver_id===u.id||c.sender_id===u.id&&c.receiver_id===a.user.id){let b=c.content;if(c.is_encrypted){let d=await q(a.user.id,u.id);try{b=await p(c.content,d)}catch(a){b="[Mensaje cifrado]"}}x(d=>{let e=d[u.id]||[];return e.some(a=>a.id===c.id)?d:{...d,[u.id]:[...e,{id:c.id,sender:c.sender_id===a.user.id?"Yo":u.name,text:b,time:new Date(c.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),isEncrypted:c.is_encrypted}]}})}}).subscribe();return()=>{h.supabase.removeChannel(b)}},[u,a?.user?.id]);let Q=async b=>{if(b.preventDefault(),!y.trim()||!u)return;let c=y.trim();z("");let d=Date.now();if(x(a=>({...a,[u.id]:[...a[u.id]||[],{id:d,sender:"Yo",text:c,time:"Ahora",isEncrypted:!1}]})),"ai"===u.type){K(!0);try{let a=await (0,k.getProducts)(30),b=(w[u.id]||[]).map(a=>({role:"Yo"===a.sender?"user":"assistant",content:a.text}));b.push({role:"user",content:c});let d=await (0,j.chatWithAI)(b,a);x(a=>({...a,[u.id]:[...a[u.id]||[],{id:Date.now(),sender:"JARVIS",text:d,time:"Ahora",isEncrypted:!1}]}))}catch(a){console.error("AI Error:",a),x(a=>({...a,[u.id]:[...a[u.id]||[],{id:Date.now(),sender:"JARVIS",text:"Error de conexiÃ³n. Intenta de nuevo.",time:"Ahora",isEncrypted:!1}]}))}finally{K(!1)}return}if(!a?.user?.id)return void alert("Debes iniciar sesiÃ³n para enviar mensajes.");let e=c,f=!1;if(F&&D[u.id])try{e=await o(c,D[u.id]),f=!0}catch(a){console.warn("Encryption failed, sending unencrypted:",a)}try{let{error:b}=await h.supabase.from("messages").insert({sender_id:a.user.id,receiver_id:u.id,content:e,is_encrypted:f});b&&(console.error("Send error:",b),x(a=>({...a,[u.id]:(a[u.id]||[]).filter(a=>a.id!==d)})),alert("Error al enviar mensaje. Verifica tu conexiÃ³n."))}catch(a){console.error("Network error:",a),x(a=>({...a,[u.id]:(a[u.id]||[]).filter(a=>a.id!==d)})),alert("Error de red. Intenta de nuevo.")}};return m?(0,b.jsxs)("div",{className:"h-screen bg-black flex flex-col overflow-hidden",children:[(0,b.jsx)(d.default,{}),(0,b.jsx)("main",{className:"flex-1 flex overflow-hidden pt-20 md:pt-24",children:(0,b.jsxs)("div",{className:"flex-1 flex max-w-[1600px] mx-auto w-full border-x border-white/5 bg-zinc-900/50",children:[(0,b.jsxs)("div",{className:`${"chat"===s?"hidden md:flex":"flex"} w-full md:w-[380px] flex-col border-r border-white/5 bg-zinc-900/80`,children:[(0,b.jsxs)("div",{className:"p-6 border-b border-white/5",children:[(0,b.jsx)("h2",{className:"text-2xl font-black text-white uppercase tracking-tighter italic mb-4",children:"Mis Amigos"}),(0,b.jsx)("div",{className:"relative",children:(0,b.jsx)("input",{type:"text",placeholder:"Buscar chat...",className:"w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none focus:ring-2 ring-blue-500/20 text-white placeholder:text-zinc-600"})})]}),(0,b.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:O.length>0?O.map(a=>(0,b.jsxs)("button",{onClick:()=>{v(a),t("chat")},className:`w-full p-4 flex items-center gap-4 transition-all border-b border-white/[0.02] ${u?.id===a.id?"bg-blue-600/10 border-l-4 border-l-blue-600":"hover:bg-white/[0.03]"}`,children:[(0,b.jsxs)("div",{className:"w-14 h-14 rounded-full bg-zinc-800 flex items-center justify-center text-2xl relative shrink-0 overflow-hidden border border-white/5",children:[a.avatar?(0,b.jsx)("img",{src:a.avatar,className:"w-full h-full object-cover"}):"ðŸ‘¤",a.online&&(0,b.jsx)("span",{className:"absolute bottom-0.5 right-0.5 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-zinc-900"})]}),(0,b.jsxs)("div",{className:"text-left flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex justify-between items-center mb-0.5",children:[(0,b.jsxs)("p",{className:"font-bold text-white truncate text-sm",children:["@",a.name]}),(0,b.jsx)("span",{className:"text-[9px] text-zinc-500 font-black uppercase tracking-widest",children:"Ahora"})]}),(0,b.jsx)("p",{className:"text-xs truncate text-zinc-500 font-medium italic",children:"Empieza a hablar..."})]})]},a.id)):(0,b.jsxs)("div",{className:"p-8 text-center space-y-4",children:[(0,b.jsx)("p",{className:"text-zinc-500 text-xs font-bold uppercase tracking-widest leading-relaxed",children:"AÃºn no tienes amigos agregados para chatear."}),(0,b.jsx)("a",{href:"/community",className:"text-blue-500 text-[10px] font-black uppercase tracking-widest hover:underline",children:"Buscar Amigos â†’"})]})})]}),(0,b.jsx)("div",{className:`${"chat"===s?"flex":"hidden md:flex"} flex-1 flex-col relative`,children:u?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"p-4 md:p-6 bg-zinc-900/90 backdrop-blur-md border-b border-white/5 flex items-center justify-between z-10",children:[(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsx)("button",{onClick:()=>t("list"),className:"md:hidden p-2 text-zinc-400",children:(0,b.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:(0,b.jsx)("path",{d:"m15 18-6-6 6-6"})})}),(0,b.jsx)("div",{className:"w-12 h-12 rounded-full bg-zinc-800 border border-white/10 flex items-center justify-center text-xl overflow-hidden shadow-2xl relative",children:u.avatar?(0,b.jsx)("img",{src:u.avatar,className:"w-full h-full object-cover"}):"ðŸ‘¤"}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h3",{className:"font-black text-white uppercase tracking-tighter italic",children:["@",u.name]}),(0,b.jsx)("span",{className:"text-[10px] text-green-500 font-black uppercase tracking-[0.2em]",children:"En LÃ­nea"})]})]}),(0,b.jsx)("div",{className:"flex gap-3",children:(0,b.jsx)("button",{className:"w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-zinc-400 hover:bg-white/10 transition-colors",children:(0,b.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:(0,b.jsx)("path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l2.27-2.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"})})})})]}),(0,b.jsx)("div",{ref:C,className:"flex-1 p-6 md:p-10 overflow-y-auto space-y-6 custom-scrollbar bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] bg-fixed",children:H?(0,b.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,b.jsx)("div",{className:"w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"})}):(w[u.id]||[]).map(a=>(0,b.jsxs)(f.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex flex-col ${"Yo"===a.sender?"items-end":"items-start"}`,children:[(0,b.jsxs)("div",{className:`max-w-[85%] md:max-w-[70%] px-5 py-3 rounded-2xl text-sm font-medium shadow-2xl relative ${"Yo"===a.sender?"bg-blue-600 text-white rounded-tr-none":"bg-zinc-800 text-white rounded-tl-none border border-white/5"}`,children:[a.text,a.isEncrypted&&(0,b.jsx)("span",{className:"absolute -bottom-1 -right-1 text-[8px] opacity-30",children:"ðŸ”’"})]}),(0,b.jsx)("span",{className:"text-[9px] font-black text-zinc-600 mt-2 uppercase tracking-widest",children:a.time})]},a.id))}),(0,b.jsx)("div",{className:"p-4 md:p-8 bg-zinc-900 border-t border-white/5",children:(0,b.jsxs)("form",{onSubmit:Q,className:"flex gap-4 max-w-4xl mx-auto",children:[(0,b.jsx)("input",{type:"text",value:y,onChange:a=>z(a.target.value),placeholder:"Escribe un mensaje aquÃ­...",className:"flex-1 bg-black border border-white/10 rounded-2xl px-6 py-4 text-sm outline-none focus:ring-2 ring-blue-500/30 text-white placeholder:text-zinc-600 font-medium"}),(0,b.jsx)("button",{type:"submit",disabled:!y.trim(),className:"bg-blue-600 text-white w-14 h-14 rounded-2xl flex items-center justify-center hover:bg-blue-700 transition-all shadow-xl shadow-blue-500/20 disabled:grayscale disabled:opacity-50 active:scale-90",children:(0,b.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,b.jsx)("path",{d:"m22 2-7 20-4-9-9-4Z"}),(0,b.jsx)("path",{d:"M22 2 11 13"})]})})]})})]}):(0,b.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center p-12 text-center bg-black/40",children:[(0,b.jsx)(f.motion.div,{animate:{scale:[1,1.1,1]},transition:{repeat:1/0,duration:3},className:"text-[120px] mb-8 grayscale opacity-20",children:"ðŸ’¬"}),(0,b.jsx)("h3",{className:"text-3xl font-black text-white uppercase tracking-tighter italic",children:"Selecciona un Chat"}),(0,b.jsx)("p",{className:"text-zinc-500 mt-4 max-w-xs font-medium italic",children:"Toca el nombre de un amigo a la izquierda para empezar a parchar."})]})})]})}),(0,b.jsx)(e.default,{})]}):(0,b.jsxs)("div",{className:"min-h-screen bg-black flex flex-col items-center justify-center p-6 text-center",children:[(0,b.jsx)(d.default,{}),(0,b.jsxs)(f.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-6 max-w-sm",children:[(0,b.jsx)("span",{className:"text-8xl block",children:"ðŸ”’"}),(0,b.jsx)("h2",{className:"text-3xl font-black text-white uppercase italic tracking-tighter",children:"Inicia SesiÃ³n"}),(0,b.jsx)("p",{className:"text-zinc-500 font-medium",children:"Debes estar logueado para parchar con tus amigos en el chat privado."}),(0,b.jsx)("a",{href:"/profile",className:"block w-full py-4 bg-blue-600 text-white rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-xl shadow-blue-500/20 active:scale-95 transition-all",children:"Ir al Perfil"})]}),(0,b.jsx)(e.default,{})]})}a.s(["default",()=>r],51107)}];

//# sourceMappingURL=app_chat_page_0b40158a.js.map